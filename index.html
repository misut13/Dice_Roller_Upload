<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiceForge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            max-width: 400px;
            margin: 0 auto;
            height: 100vh;
            background: #f3e9d2;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: url('header.png') no-repeat center;
            background-size: 100% 100%;
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            height: 83px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .screen {
            display: none;
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        #profileDetailScreen {
            padding-bottom: 100px;
        }

        .screen.active {
            display: block;
        }

        .profile-list {
            margin-bottom: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .profile-card {
            background: url('Button4.png') no-repeat center;
            background-size: 100% 100%;
            border-radius: 8px;
            padding: 16px 16px 16px calc(16px + 2ch);
            margin-bottom: 12px;
            box-shadow: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            color: black;
        }

        .profile-name {
            font-size: 18px;
            font-weight: bold;
            color: black;
            margin-bottom: 8px;
        }

        .profile-stats {
            font-size: 12px;
            color: black;
            display: flex;
            gap: 16px;
        }

        .profile-delete-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .btn {
            background: url('Button4.png') no-repeat center;
            background-size: 100% 100%;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
            height: 60px;
            padding: 0 10px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-secondary {
            background: url('Button2.png') no-repeat center;
            background-size: 100% 100%;
            color: black;
            font-weight: bold;
        }

        .btn-danger {
            background: url('Button2.png') no-repeat center;
            background-size: 100% 100%;
        }

        .btn-wood {
            background: url('Button2.png') no-repeat center;
            background-size: 100% 100%;
            color: black;
        }

        #createNewProfileBtn {
            font-weight: bold;
        }

        #addDiceFunctionBtn,
        #addSimpleDiceBtn,
        #deleteModeBtn {
            color: black;
            font-weight: bold;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #2d3748;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .dice-function-card, .simple-dice-card {
            border-radius: 8px;
            margin-bottom: 8px;
            border: none;
            position: relative;
            cursor: pointer;
            background: url('Button4.png') no-repeat center;
            background-size: 100% 100%;
            color: black;
        }

        .dice-function-card {
            padding: 8px;
            padding-left: calc(8px + 2ch);
        }

        .simple-dice-card {
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .simple-dice-card .dice-function-name {
            margin-bottom: 0;
            width: 100%;
            text-align: center;
        }

        .dice-function-name {
            font-size: 16px;
            font-weight: bold;
            color: black;
            margin-bottom: 4px;
        }

        .dice-function-formula {
            font-family: 'Courier New', monospace;
            color: black;
            font-size: 12px;
            margin-bottom: 6px;
        }

        .back-btn, .settings-btn {
            position: absolute;
            top: 20px;
            background: url('Button5.png') no-repeat center;
            background-size: cover;
            color: black;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .back-btn {
            left: 20px;
        }

        .settings-btn {
            right: 20px;
            font-size: 20px;
            font-weight: bold;
        }

        .settings-overlay {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 400px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .settings-overlay.active {
            display: flex;
        }

        .settings-panel {
            background: #f3e9d2;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 300px;
        }

        #profileContent {
            display: flex;
            gap: 16px;
        }

        #diceFunctions {
            flex: 3;
            overflow-y: auto;
        }

        #simpleDices {
            flex: 1;
            overflow-y: auto;
        }

        #profileContent.dimmed {
            opacity: 0.3;
            pointer-events: none;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Result popup */
        .result-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .result-popup .popup-content {
            background: url('Button5.png') no-repeat center;
            background-size: 100% 100%;
            padding: 40px 20px 20px;
            text-align: center;
            width: 80%;
            max-width: 300px;
            color: black;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .result-popup .roll-name {
            font-weight: bold;
        }

        .result-popup .roll-result {
            margin-top: 10px;
        }

        .result-popup .btn {
            margin-top: 20px;
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <button class="back-btn" id="backBtn" style="display: none;">‚Ü©</button>
            <button class="settings-btn" id="settingsBtn" style="display: none;">‚õ≠</button>
            <h1 id="headerTitle">DiceForge</h1>
            <div class="subtitle" id="headerSubtitle"></div>
        </div>

        <!-- Profile List Screen -->
        <div class="screen active" id="profileListScreen">
            <div class="profile-list" id="profileList">
                <div class="empty-state">
                    <div class="icon">üé≤</div>
                    <h3>Keine Profile vorhanden</h3>
                    <p>Erstellen Sie Ihr erstes Charakterprofil</p>
                </div>
            </div>
            <button class="btn btn-wood" id="createNewProfileBtn">Neues Profil erstellen</button>
        </div>

        <!-- Create Profile Screen -->
        <div class="screen" id="createProfileScreen">
            <h2>Neues Profil erstellen</h2>
            <div class="input-group">
                <label for="profileName">Profilname:</label>
                <input type="text" id="profileName" placeholder="z.B. Gandalf der Graue" maxlength="20">
            </div>
            <button class="btn btn-secondary" id="createProfileBtn">Profil erstellen</button>
            <button class="btn btn-secondary" id="cancelCreateProfileBtn">Abbrechen</button>
        </div>

        <!-- Profile Detail Screen -->
        <div class="screen" id="profileDetailScreen">
            <div id="profileContent">
                <div id="diceFunctions">
                    <div id="attackFunctionsList"></div>
                    <div id="diceFunctionsList"></div>
                </div>

                <div id="simpleDices">
                    <div id="simpleDicesList"></div>
                </div>
            </div>

            <div id="settingsOverlay" class="settings-overlay">
                <div class="settings-panel">
                    <button class="btn btn-wood" id="addAttackFunctionBtn"><strong>Angriffsfunktion hinzuf√ºgen</strong></button>
                    <button class="btn btn-wood" id="addDiceFunctionBtn">W√ºrfelfunktion hinzuf√ºgen</button>
                    <button class="btn btn-wood" id="addSimpleDiceBtn">Einfachen W√ºrfel hinzuf√ºgen</button>
                    <button class="btn btn-danger" id="deleteModeBtn">L√∂schen</button>
                </div>
            </div>
        </div>

        <!-- Add Dice Function Screen -->
        <div class="screen" id="addDiceFunctionScreen">
            <h2>W√ºrfelfunktion hinzuf√ºgen</h2>
            <div class="input-group">
                <label for="functionName">Name:</label>
                <input type="text" id="functionName" placeholder="z.B. Feuerball Schaden" maxlength="18">
            </div>
            <div class="input-group">
                <label for="functionFormula">Formel:</label>
                <input type="text" id="functionFormula" placeholder="z.B. 3w6+3" maxlength="15">
                <small>Format: Kombinationen wie 3w6+3 oder 3w6+3+2w6-2</small>
            </div>
            <button class="btn btn-secondary" id="saveDiceFunctionBtn">Hinzuf√ºgen</button>
            <button class="btn btn-secondary" id="cancelDiceFunctionBtn">Abbrechen</button>
        </div>

        <!-- Add Simple Dice Screen -->
        <div class="screen" id="addSimpleDiceScreen">
            <h2>Einfachen W√ºrfel hinzuf√ºgen</h2>
            <div class="input-group">
                <label for="diceType">W√ºrfeltyp:</label>
                <select id="diceType">
                    <option value="3">W3</option>
                    <option value="4">W4</option>
                    <option value="6">W6</option>
                    <option value="8">W8</option>
                    <option value="10">W10</option>
                    <option value="12">W12</option>
                    <option value="20">W20</option>
                    <option value="100">W100</option>
                    <option value="custom">Individueller W√ºrfel</option>
                </select>
                <input type="number" id="customDiceSides" placeholder="Seitenanzahl" style="display:none;" min="1">
            </div>
            <button class="btn btn-secondary" id="saveSimpleDiceBtn">Hinzuf√ºgen</button>
            <button class="btn btn-secondary" id="cancelSimpleDiceBtn">Abbrechen</button>
        </div>
        <!-- Add Attack Function Screen -->
        <div class="screen" id="addAttackFunctionScreen">
            <h2><strong>Angriffsfunktion hinzuf√ºgen</strong></h2>
            <div class="input-group">
                <label for="attackFunctionName">Name:</label>
                <input type="text" id="attackFunctionName" placeholder="z.B. Schwerthieb" maxlength="18">
            </div>
            <div class="input-group">
                <label for="attackFunctionAttack">Angriffswurf:</label>
                <input type="text" id="attackFunctionAttack" placeholder="z.B. 1w20+5" maxlength="15">
            </div>
            <div class="input-group">
                <label for="attackFunctionDamage">Schadenswurf:</label>
                <input type="text" id="attackFunctionDamage" placeholder="z.B. 2w4+1" maxlength="15">
            </div>
            <button class="btn btn-secondary" id="saveAttackFunctionBtn">Hinzuf√ºgen</button>
            <button class="btn btn-secondary" id="cancelAttackFunctionBtn">Abbrechen</button>
        </div>
        <div id="lastRollBar" class="result-popup" style="display:none;">
            <div class="popup-content">
                <div id="lastRollText"></div>
                <button class="btn btn-secondary" id="closeResultBtn">Schliessen</button>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let profiles = [];
        let currentProfile = null;
        let lastRoll = null;
        let deleteMode = false;

        const standardDiceSides = [3, 4, 6, 8, 10, 12, 20, 100];

        // Persistenz √ºber Local Storage
        function saveProfiles() {
            localStorage.setItem('profiles', JSON.stringify(profiles));
        }

        function loadProfiles() {
            try {
                const stored = localStorage.getItem('profiles');
                profiles = stored ? JSON.parse(stored) : [];
            } catch (e) {
                profiles = [];
            }
        }

        // App initialisieren
        function initializeApp() {
            loadProfiles();
        }

        // Utility Functions
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text.toString();
            return div.innerHTML;
        }

        function generateId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }

        // Screen Management
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            const backBtn = document.getElementById('backBtn');
            const settingsBtn = document.getElementById('settingsBtn');
            if (screenId === 'profileListScreen') {
                backBtn.style.display = 'none';
                settingsBtn.style.display = 'none';
            } else if (screenId === 'profileDetailScreen') {
                backBtn.style.display = 'block';
                settingsBtn.style.display = 'block';
            } else {
                backBtn.style.display = 'block';
                settingsBtn.style.display = 'none';
            }
            updateLastRollBar();
        }

        function showProfileList() {
            showScreen('profileListScreen');
            const headerTitle = document.getElementById('headerTitle');
            headerTitle.textContent = 'DiceForge';
            headerTitle.style.fontSize = '';
            document.getElementById('headerSubtitle').textContent = '';
            renderProfiles();
        }

        function showCreateProfile() {
            showScreen('createProfileScreen');
            const headerTitle = document.getElementById('headerTitle');
            headerTitle.textContent = 'Neues Profil';
            headerTitle.style.fontSize = '';
            document.getElementById('headerSubtitle').textContent = 'Charakterprofil erstellen';
            document.getElementById('profileName').value = '';
        }

        function showProfileDetail() {
            showScreen('profileDetailScreen');
            deleteMode = false;
            if (currentProfile) {
                const headerTitle = document.getElementById('headerTitle');
                headerTitle.textContent = currentProfile.name;
                // Reduce oversized profile names by two font-size steps
                headerTitle.style.fontSize = currentProfile.name.length > 14 ? '16px' : '';
                document.getElementById('headerSubtitle').textContent = '';
                renderProfileDetail();
            }
        }

        function showAddAttackFunction() {
            closeSettings();
            showScreen('addAttackFunctionScreen');
            const headerTitle = document.getElementById('headerTitle');
            headerTitle.textContent = 'Angriffsfunktion';
            headerTitle.style.fontSize = '';
            document.getElementById('headerSubtitle').textContent = 'Neue Funktion hinzuf√ºgen';
            document.getElementById('attackFunctionName').value = '';
            document.getElementById('attackFunctionAttack').value = '';
            document.getElementById('attackFunctionDamage').value = '';
        }

        function showAddDiceFunction() {
            closeSettings();
            showScreen('addDiceFunctionScreen');
            const headerTitle = document.getElementById('headerTitle');
            headerTitle.textContent = 'W√ºrfelfunktion';
            headerTitle.style.fontSize = '';
            document.getElementById('headerSubtitle').textContent = 'Neue Funktion hinzuf√ºgen';
            document.getElementById('functionName').value = '';
            document.getElementById('functionFormula').value = '';
        }

        function showAddSimpleDice() {
            closeSettings();
            showScreen('addSimpleDiceScreen');
            const headerTitle = document.getElementById('headerTitle');
            headerTitle.textContent = 'Einfacher W√ºrfel';
            headerTitle.style.fontSize = '';
            document.getElementById('headerSubtitle').textContent = 'Neuen W√ºrfel hinzuf√ºgen';
            document.getElementById('diceType').value = '6';
            document.getElementById('customDiceSides').value = '';
            document.getElementById('customDiceSides').style.display = 'none';
        }

        // Profile Management
        function renderProfiles() {
            const profileList = document.getElementById('profileList');
            
            if (profiles.length === 0) {
                profileList.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üé≤</div>
                        <h3>Keine Profile vorhanden</h3>
                        <p>Erstellen Sie Ihr erstes Charakterprofil</p>
                    </div>
                `;
                return;
            }

            profileList.innerHTML = '';
            profiles.forEach(profile => {
                const profileCard = document.createElement('div');
                profileCard.className = 'profile-card';
                profileCard.innerHTML = `
                    <button class="profile-delete-btn" title="Profil l√∂schen">√ó</button>
                    <div class="profile-name">${escapeHtml(profile.name)}</div>
                    <div class="profile-stats">
                        <span>üìú ${(profile.diceFunctions || []).length + (profile.attackFunctions || []).length} Funktionen</span>
                        <span>üé≤ ${(profile.simpleDices || []).length} W√ºrfel</span>
                    </div>
                `;
                
                // Event Listeners
                profileCard.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('profile-delete-btn')) {
                        openProfile(profile.id);
                    }
                });
                
                profileCard.querySelector('.profile-delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    profiles = profiles.filter(p => p.id !== profile.id);
                    saveProfiles();
                    renderProfiles();
                });
                
                profileList.appendChild(profileCard);
            });
        }

        function createProfile() {
            const name = document.getElementById('profileName').value.trim();
            if (!name) {
                alert('Bitte geben Sie einen Profilnamen ein.');
                return;
            }
            if (name.length > 20) {
                alert('Profilname darf maximal 20 Zeichen lang sein.');
                return;
            }

            const profile = {
                id: generateId(),
                name: name,
                diceFunctions: [],
                attackFunctions: [],
                simpleDices: standardDiceSides.map(sides => ({ sides }))
            };

            profiles.push(profile);
            saveProfiles();
            showProfileList();
        }

        function openProfile(profileId) {
            currentProfile = profiles.find(p => p.id === profileId);
            lastRoll = null;
            showProfileDetail();
        }

        // Profile Detail Rendering
        function renderProfileDetail() {
            const attackFunctionsList = document.getElementById('attackFunctionsList');
            const diceFunctionsList = document.getElementById('diceFunctionsList');
            const simpleDicesList = document.getElementById('simpleDicesList');

            // Clear previous content
            attackFunctionsList.innerHTML = '';
            diceFunctionsList.innerHTML = '';
            simpleDicesList.innerHTML = '';

            // Angriffsfunktionen und W√ºrfelfunktionen
            const hasAttackFunctions = currentProfile.attackFunctions && currentProfile.attackFunctions.length > 0;
            const hasDiceFunctions = currentProfile.diceFunctions && currentProfile.diceFunctions.length > 0;

            if (!hasAttackFunctions && !hasDiceFunctions) {
                attackFunctionsList.innerHTML = '<p style="color: #718096; font-style: italic;">Es sind keine Funktionen definiert</p>';
            } else {
                if (hasAttackFunctions) {
                    currentProfile.attackFunctions.forEach((func, index) => {
                        const card = document.createElement('div');
                        card.className = 'dice-function-card';
                        const name = escapeHtml(func.name.substring(0, 18));
                        card.innerHTML = `
                            <div class="dice-function-name">${name}</div>
                            <div class="dice-function-formula">A: ${escapeHtml(func.attack)} | S: ${escapeHtml(func.damage)}</div>
                        `;

                        card.addEventListener('click', (e) => {
                            if (deleteMode) {
                                e.stopPropagation();
                                e.preventDefault();
                                currentProfile.attackFunctions.splice(index, 1);
                                deleteMode = false;
                                saveProfiles();
                                renderProfileDetail();
                                return;
                            }
                            rollAttackFunction(index);
                        });

                        attackFunctionsList.appendChild(card);
                    });
                }

                if (hasDiceFunctions) {
                    currentProfile.diceFunctions.forEach((func, index) => {
                        const card = document.createElement('div');
                        card.className = 'dice-function-card';
                        const name = escapeHtml(func.name.substring(0, 18));
                        card.innerHTML = `
                            <div class="dice-function-name">${name}</div>
                            <div class="dice-function-formula">${escapeHtml(func.formula)}</div>
                        `;

                        card.addEventListener('click', (e) => {
                            if (deleteMode) {
                                e.stopPropagation();
                                e.preventDefault();
                                currentProfile.diceFunctions.splice(index, 1);
                                deleteMode = false;
                                saveProfiles();
                                renderProfileDetail();
                                return;
                            }
                            rollDiceFunction(index);
                        });

                        diceFunctionsList.appendChild(card);
                    });
                }
            }

            // Einfache W√ºrfel
            if (!currentProfile.simpleDices || currentProfile.simpleDices.length === 0) {
                simpleDicesList.innerHTML = '<p style="color: #718096; font-style: italic;">Keine einfachen W√ºrfel hinzugef√ºgt</p>';
            } else {
                currentProfile.simpleDices.forEach((dice, index) => {
                    const card = document.createElement('div');
                    card.className = 'simple-dice-card';
                    card.innerHTML = `
                        <div class="dice-function-name">W${dice.sides}</div>
                    `;

                    card.addEventListener('click', (e) => {
                        if (deleteMode) {
                            e.stopPropagation();
                            e.preventDefault();
                            currentProfile.simpleDices.splice(index, 1);
                            deleteMode = false;
                            saveProfiles();
                            renderProfileDetail();
                            return;
                        }
                        rollSimpleDice(index);
                    });

                    simpleDicesList.appendChild(card);
                });
            }

            updateLastRollBar();
        }

        function updateLastRollBar() {
            const bar = document.getElementById('lastRollBar');
            const text = document.getElementById('lastRollText');
            const active = document.querySelector('.screen.active').id;
            if (active === 'profileDetailScreen' && lastRoll) {
                bar.style.display = 'flex';
                if (lastRoll.isAttack) {
                    text.innerHTML = `
                        <div class="roll-name">${escapeHtml(lastRoll.name)}</div>
                        <div class="roll-result"><strong>Angriff:</strong> ${escapeHtml(lastRoll.attack.details)} = <strong>${lastRoll.attack.result}</strong></div>
                        <div class="roll-result"><strong>Schaden:</strong> ${escapeHtml(lastRoll.damage.details)} = <strong>${lastRoll.damage.result}</strong></div>
                    `.trim();
                } else {
                    text.innerHTML = `
                        <div class="roll-name">${escapeHtml(lastRoll.name)}</div>
                        <div class="roll-result">${escapeHtml(lastRoll.details)} = <strong>${lastRoll.result}</strong></div>
                    `.trim();
                }
            } else {
                bar.style.display = 'none';
            }
        }

        // Dice Functions
        function addAttackFunction() {
            const name = document.getElementById('attackFunctionName').value.trim().substring(0, 18);
            const attack = document.getElementById('attackFunctionAttack').value.trim();
            const damage = document.getElementById('attackFunctionDamage').value.trim();

            if (!name || !attack || !damage) {
                alert('Bitte f√ºllen Sie alle Felder aus.');
                return;
            }
            if (name.length > 18) {
                alert('Der Name der Angriffsfunktion darf maximal 18 Zeichen lang sein.');
                return;
            }
            if (attack.length > 15 || damage.length > 15) {
                alert('Die W√ºrfelformel darf maximal 15 Zeichen lang sein.');
                return;
            }

            if (!isValidFormula(attack) || !isValidFormula(damage)) {
                alert('Ung√ºltige Formel. Beispiele: 3w6+3 oder 3w6+3+2w6-2');
                return;
            }

            currentProfile.attackFunctions.push({ name, attack, damage });
            saveProfiles();
            lastRoll = null;
            showProfileDetail();
        }

        function addDiceFunction() {
            const name = document.getElementById('functionName').value.trim().substring(0, 18);
            const formula = document.getElementById('functionFormula').value.trim();

            if (!name || !formula) {
                alert('Bitte f√ºllen Sie alle Felder aus.');
                return;
            }
            if (name.length > 18) {
                alert('Der Name der W√ºrfelfunktion darf maximal 18 Zeichen lang sein.');
                return;
            }
            if (formula.length > 15) {
                alert('Die W√ºrfelformel darf maximal 15 Zeichen lang sein.');
                return;
            }

            if (!isValidFormula(formula)) {
                alert('Ung√ºltige Formel. Beispiele: 3w6+3 oder 3w6+3+2w6-2');
                return;
            }

            currentProfile.diceFunctions.push({ name, formula });
            saveProfiles();
            lastRoll = null;
            showProfileDetail();
        }

        // Simple Dice
        function addSimpleDice() {
            const type = document.getElementById('diceType').value;
            let sides;
            if (type === 'custom') {
                sides = parseInt(document.getElementById('customDiceSides').value, 10);
            } else {
                sides = parseInt(type, 10);
            }
            if (!sides || sides < 1) {
                alert('Bitte geben Sie eine g√ºltige Seitenanzahl ein');
                return;
            }
            currentProfile.simpleDices.push({ sides });
            saveProfiles();
            lastRoll = null;
            showProfileDetail();
        }

        // Dice Rolling
        function isValidFormula(formula) {
            return parseFormula(formula) !== null;
        }

        function parseFormula(formula) {
            if (!formula) return null;
            const clean = formula.replace(/\s+/g, '').replace(/-/g, '+-');
            const tokens = clean.split('+').filter(t => t);
            const terms = [];

            for (let token of tokens) {
                let sign = 1;
                if (token.startsWith('-')) {
                    sign = -1;
                    token = token.slice(1);
                }
                const diceMatch = token.match(/^(\d*)[wWdD](\d+)$/);
                if (diceMatch) {
                    const count = parseInt(diceMatch[1] || '1', 10);
                    const sides = parseInt(diceMatch[2], 10);
                    terms.push({ type: 'dice', count, sides, sign });
                } else if (/^\d+$/.test(token)) {
                    terms.push({ type: 'number', value: sign * parseInt(token, 10) });
                } else {
                    return null;
                }
            }
            return terms;
        }

        function rollDice(sides) {
            return Math.floor(Math.random() * sides) + 1;
        }

        function rollFromFormula(formula) {
            const terms = parseFormula(formula);
            if (!terms) return null;
            let total = 0;
            const detailParts = [];

            terms.forEach(term => {
                if (term.type === 'dice') {
                    const rolls = [];
                    for (let r = 0; r < term.count; r++) {
                        rolls.push(rollDice(term.sides));
                    }
                    const sum = rolls.reduce((a, b) => a + b, 0) * term.sign;
                    total += sum;
                    const sign = term.sign < 0 ? '-' : (detailParts.length ? '+' : '');
                    detailParts.push(`${sign}${term.count}w${term.sides} [${rolls.join(', ')}]`);
                } else {
                    total += term.value;
                    const sign = term.value < 0 ? '-' : (detailParts.length ? '+' : '');
                    detailParts.push(`${sign}${Math.abs(term.value)}`);
                }
            });

            return { total, detail: detailParts.join(' ') };
        }

        function rollDiceFunction(index) {
            const func = currentProfile.diceFunctions[index];
            const result = rollFromFormula(func.formula);

            if (!result) {
                alert('Fehlerhafte Formel');
                return;
            }

            lastRoll = {
                name: func.name,
                details: result.detail,
                result: result.total
            };
            updateLastRollBar();
        }

        function rollAttackFunction(index) {
            const func = currentProfile.attackFunctions[index];
            const attack = rollFromFormula(func.attack);
            const damage = rollFromFormula(func.damage);

            if (!attack || !damage) {
                alert('Fehlerhafte Formel');
                return;
            }

            lastRoll = {
                name: func.name,
                isAttack: true,
                attack: { details: attack.detail, result: attack.total },
                damage: { details: damage.detail, result: damage.total }
            };
            updateLastRollBar();
        }

        function rollSimpleDice(index) {
            const dice = currentProfile.simpleDices[index];
            const result = rollDice(dice.sides);

            lastRoll = {
                name: `W${dice.sides}`,
                details: `1w${dice.sides}`,
                result: result
            };
            updateLastRollBar();
        }

        // Settings
        function toggleSettings() {
            const overlay = document.getElementById('settingsOverlay');
            const profileContent = document.getElementById('profileContent');

            if (overlay.classList.contains('active')) {
                overlay.classList.remove('active');
                profileContent.classList.remove('dimmed');
            } else {
                overlay.classList.add('active');
                profileContent.classList.add('dimmed');
                deleteMode = false;
            }
        }

        function closeSettings() {
            const overlay = document.getElementById('settingsOverlay');
            const profileContent = document.getElementById('profileContent');
            overlay.classList.remove('active');
            profileContent.classList.remove('dimmed');
        }

        function enableDeleteMode() {
            deleteMode = true;
            closeSettings();
        }

        // Initialize Event Listeners
        function initializeEventListeners() {
            // Navigation
            document.getElementById('backBtn').addEventListener('click', () => {
                const currentScreen = document.querySelector('.screen.active').id;
                if (currentScreen === 'createProfileScreen') {
                    showProfileList();
                } else if (currentScreen === 'profileDetailScreen') {
                    showProfileList();
                } else if (currentScreen === 'addAttackFunctionScreen' || currentScreen === 'addDiceFunctionScreen' || currentScreen === 'addSimpleDiceScreen') {
                    showProfileDetail();
                }
            });

            document.getElementById('settingsBtn').addEventListener('click', toggleSettings);

            // Settings Overlay
            document.getElementById('settingsOverlay').addEventListener('click', (e) => {
                if (e.target.id === 'settingsOverlay') {
                    closeSettings();
                }
            });

            // Profile creation
            document.getElementById('createNewProfileBtn').addEventListener('click', showCreateProfile);
            document.getElementById('createProfileBtn').addEventListener('click', createProfile);
            document.getElementById('cancelCreateProfileBtn').addEventListener('click', showProfileList);

            // Settings panel
            document.getElementById('addAttackFunctionBtn').addEventListener('click', showAddAttackFunction);
            document.getElementById('addDiceFunctionBtn').addEventListener('click', showAddDiceFunction);
            document.getElementById('addSimpleDiceBtn').addEventListener('click', showAddSimpleDice);
            document.getElementById('deleteModeBtn').addEventListener('click', enableDeleteMode);

            // Dice function creation
            document.getElementById('saveAttackFunctionBtn').addEventListener('click', addAttackFunction);
            document.getElementById('cancelAttackFunctionBtn').addEventListener('click', showProfileDetail);
            document.getElementById('saveDiceFunctionBtn').addEventListener('click', addDiceFunction);
            document.getElementById('cancelDiceFunctionBtn').addEventListener('click', showProfileDetail);

            // Simple dice creation
            document.getElementById('saveSimpleDiceBtn').addEventListener('click', addSimpleDice);
            document.getElementById('cancelSimpleDiceBtn').addEventListener('click', showProfileDetail);
            document.getElementById('diceType').addEventListener('change', (e) => {
                const custom = document.getElementById('customDiceSides');
                if (e.target.value === 'custom') {
                    custom.style.display = 'block';
                } else {
                    custom.style.display = 'none';
                }
            });
            document.getElementById('closeResultBtn').addEventListener('click', () => {
                document.getElementById('lastRollBar').style.display = 'none';
            });
        }

        // Initialize App
        initializeApp();
        initializeEventListeners();
        showProfileList();
    </script>
</body>
</html>
